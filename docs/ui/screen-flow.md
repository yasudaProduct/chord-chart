# 画面遷移図

ChordBook アプリケーションの画面遷移フローを説明します。

---

## 全体遷移図

```
                                    ┌─────────────┐
                                    │   ホーム    │
                                    │     /       │
                                    └──────┬──────┘
                                           │
                    ┌──────────────────────┼──────────────────────┐
                    │                      │                      │
                    ▼                      ▼                      ▼
            ┌─────────────┐        ┌─────────────┐        ┌─────────────┐
            │  ログイン   │◄──────►│  新規登録   │        │    検索     │
            │   /login    │        │  /register  │        │   /search   │
            └──────┬──────┘        └──────┬──────┘        └──────┬──────┘
                   │                      │                      │
                   │ ログイン成功         │ 登録成功             │
                   │                      │                      │
                   └──────────┬───────────┘                      │
                              │                                  │
                              ▼                                  │
                      ┌─────────────┐                           │
         ┌───────────►│  楽曲一覧   │◄──────────────────────────┘
         │            │   /songs    │                  ブックマーク時
         │            └──────┬──────┘
         │                   │
         │    ┌──────────────┼──────────────┬──────────────┐
         │    │              │              │              │
         │    ▼              ▼              ▼              ▼
         │ ┌─────────┐ ┌─────────────┐ ┌─────────────┐ ┌─────────────┐
         │ │プロフィール│ │ 楽曲新規作成 │ │  楽曲詳細   │ │ ブックマーク │
         │ │ /profile │ │ /songs/new  │ │ /songs/:id  │ │  一覧       │
         │ └─────────┘ └──────┬──────┘ └──────┬──────┘ └─────────────┘
         │                    │              │
         │                    │ 作成完了     │ 編集ボタン
         │                    │              │
         │                    └──────┬───────┘
         │                           │
         │                           ▼
         │                   ┌─────────────┐
         └───────────────────│  エディタ   │
              ロゴクリック   │ /editor/:id │
                             └─────────────┘


        ──────────────────────────────────────────────────────────

        【外部共有フロー】

                      共有リンク
                          │
                          ▼
                  ┌─────────────┐
                  │ 共有楽曲表示 │
                  │/share/:token│
                  └──────┬──────┘
                         │
                         │ ログインして編集
                         ▼
                  ┌─────────────┐
                  │  ログイン   │
                  │   /login    │
                  └─────────────┘
```

---

## 認証フロー

```
┌───────────────────────────────────────────────────────────────────┐
│                          未認証状態                                │
├───────────────────────────────────────────────────────────────────┤
│                                                                   │
│    ┌─────────┐      ┌─────────┐      ┌─────────┐                 │
│    │  ホーム  │ ────►│ログイン │◄────►│新規登録 │                 │
│    └─────────┘      └────┬────┘      └────┬────┘                 │
│         │                │                │                       │
│         │                │ 認証成功       │ 登録成功               │
│         ▼                ▼                ▼                       │
│    ┌─────────┐      ┌──────────────────────────┐                 │
│    │  検索   │      │       認証済み状態        │                 │
│    └─────────┘      └──────────────────────────┘                 │
│         │                                                         │
│         │ 閲覧のみ可能                                            │
│         ▼                                                         │
│    ┌─────────────┐                                                │
│    │ 共有楽曲表示 │                                                │
│    └─────────────┘                                                │
│                                                                   │
└───────────────────────────────────────────────────────────────────┘

┌───────────────────────────────────────────────────────────────────┐
│                          認証済み状態                              │
├───────────────────────────────────────────────────────────────────┤
│                                                                   │
│    全画面にアクセス可能                                            │
│                                                                   │
│    ・楽曲一覧（/songs）                                           │
│    ・楽曲詳細（/songs/:id）                                        │
│    ・楽曲新規作成（/songs/new）                                    │
│    ・エディタ（/editor/:id）                                       │
│    ・検索（/search）                                              │
│    ・プロフィール（/profile）                                      │
│    ・共有楽曲表示（/share/:token）                                 │
│                                                                   │
│    ログアウト → 未認証状態へ → ホーム画面にリダイレクト             │
│                                                                   │
└───────────────────────────────────────────────────────────────────┘
```

---

## 楽曲管理フロー

### 新規作成フロー

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  楽曲一覧   │────►│ 楽曲新規作成 │────►│  エディタ   │
│   /songs    │     │ /songs/new  │     │ /editor/:id │
└─────────────┘     └─────────────┘     └─────────────┘
       │                  │                    │
       │            「キャンセル」          「保存」
       │                  │                    │
       ◄──────────────────┘                    │
       │                                       │
       │              「ロゴクリック」          │
       ◄───────────────────────────────────────┘


【詳細ステップ】

1. 楽曲一覧で「+ 新規作成」をクリック
2. 楽曲新規作成画面でメタ情報を入力
   - 曲名（必須）
   - アーティスト
   - キー
   - BPM
   - 拍子
3. 「エディタを開く」をクリック
4. 楽曲が作成され、エディタ画面へ遷移
5. セクション・コードを編集
6. 自動保存 or Ctrl+S で保存
```

### 編集フロー

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│  楽曲一覧   │────►│  楽曲詳細   │────►│  エディタ   │
│   /songs    │     │ /songs/:id  │     │ /editor/:id │
└─────────────┘     └─────────────┘     └─────────────┘
                          │                    │
                    「戻る」              「保存」
                          │                    │
                          ▼                    │
                   ┌─────────────┐             │
                   │  楽曲一覧   │◄────────────┘
                   │   /songs    │      「ロゴクリック」
                   └─────────────┘


【詳細ステップ】

1. 楽曲一覧で楽曲カードをクリック
2. 楽曲詳細画面でコード譜を確認
3. 「編集」ボタンをクリック
4. エディタ画面でセクション・コードを編集
5. 自動保存 or Ctrl+S で保存
6. ロゴクリックで楽曲一覧に戻る
```

---

## 共有フロー

### 共有リンク生成

```
┌─────────────┐
│  楽曲詳細   │
│ /songs/:id  │
└──────┬──────┘
       │
       │ 「共有」ボタン
       ▼
┌─────────────────────────────────────┐
│         共有設定モーダル             │
├─────────────────────────────────────┤
│                                     │
│  公開設定:                          │
│  ○ 非公開（自分のみ）               │
│  ● URL共有（リンクを知っている人）   │
│  ○ 公開（全ユーザー）               │
│                                     │
│  ─────────────────────────────────  │
│                                     │
│  共有リンク:                        │
│  https://chordbook.app/share/xyz123 │
│  [コピー]                           │
│                                     │
│  有効期限: [無期限 ▼]               │
│                                     │
│  [閉じる]                           │
│                                     │
└─────────────────────────────────────┘
```

### 共有リンクからのアクセス

```
外部ユーザー
     │
     │ 共有リンクをクリック
     ▼
┌─────────────┐
│ 共有楽曲表示 │
│/share/:token│
└──────┬──────┘
       │
       ├─────────────────────────────────┐
       │                                 │
       ▼                                 ▼
  「印刷/PDF」                    「ログインして編集」
       │                                 │
       ▼                                 ▼
  PDF出力                         ┌─────────────┐
                                  │  ログイン   │
                                  │   /login    │
                                  └──────┬──────┘
                                         │
                                         │ ログイン成功
                                         ▼
                                  ┌─────────────┐
                                  │  楽曲詳細   │  ※ブックマークに追加
                                  │ /songs/:id  │    されている場合
                                  └─────────────┘
```

---

## 検索・ブックマークフロー

```
┌─────────────┐     ┌─────────────┐     ┌─────────────┐
│    検索     │────►│  楽曲詳細   │────►│ ブックマーク │
│   /search   │     │ /songs/:id  │     │   に追加    │
└─────────────┘     └──────┬──────┘     └─────────────┘
                          │
                          │ 「ブックマーク追加」
                          ▼
                   ┌─────────────┐
                   │ ブックマーク │
                   │   一覧へ    │
                   └─────────────┘


【詳細ステップ】

1. 検索画面でキーワードを入力
2. 検索結果から楽曲を選択
3. 楽曲詳細画面でコード譜を確認
4. 「ブックマーク」ボタンをクリック
5. マイブックマーク一覧に追加
```

---

## エディタ内部フロー

### セクション操作フロー

```
┌─────────────────────────────────────────────────────────────────┐
│                         エディタ画面                            │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌─────────────┐                                                │
│  │  セクション  │                                                │
│  └──────┬──────┘                                                │
│         │                                                       │
│    ┌────┴────┬──────────┬──────────┬──────────┐               │
│    │         │          │          │          │               │
│    ▼         ▼          ▼          ▼          ▼               │
│ ドラッグ   形式切替    複製      削除      折りたたみ           │
│ 並び替え                                                       │
│    │         │          │          │          │               │
│    ▼         ▼          ▼          ▼          ▼               │
│ セクション  歌詞+コード  新しい    セクション   セクション        │
│ 順序変更    ⇔ 小節     セクション  を削除    を最小化          │
│             形式切替    を挿入                                  │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

### コード入力フロー

```
コードレーンをクリック
        │
        ▼
┌─────────────────┐
│ コード入力開始   │
└────────┬────────┘
         │
         │ 文字入力
         ▼
┌─────────────────┐     ┌─────────────────────────────┐
│ 補完候補表示     │────►│ 候補を選択（クリック/Enter） │
└────────┬────────┘     └─────────────┬───────────────┘
         │                            │
         │ Escape                     │
         ▼                            ▼
┌─────────────────┐          ┌─────────────────┐
│ 入力キャンセル   │          │ コード確定      │
└─────────────────┘          └────────┬────────┘
                                      │
                                      │ Tab キー
                                      ▼
                             ┌─────────────────┐
                             │ 次の入力位置へ   │
                             └─────────────────┘
```

---

## 状態遷移（保存状態）

```
     ┌───────────────────────────────────────────────────────┐
     │                                                       │
     │    ┌──────────┐                                       │
     │    │ 保存済み  │                                       │
     │    └────┬─────┘                                       │
     │         │                                             │
     │         │ 編集操作                                     │
     │         ▼                                             │
     │    ┌──────────┐                                       │
     │    │ 編集中    │◄────────────────────────┐            │
     │    │(isDirty) │                         │            │
     │    └────┬─────┘                         │            │
     │         │                               │            │
     │         │ 2秒間操作なし                  │ 編集操作    │
     │         │ または Ctrl+S                 │            │
     │         ▼                               │            │
     │    ┌──────────┐                         │            │
     │    │ 保存中... │─────────────────────────┘            │
     │    └────┬─────┘  保存中に編集があった場合              │
     │         │                                             │
     │         │ 保存成功                                     │
     │         ▼                                             │
     │    ┌──────────┐                                       │
     └────│ 保存済み  │                                       │
          └──────────┘                                       │
                                                             │
          保存失敗                                            │
              │                                              │
              ▼                                              │
         ┌──────────┐                                        │
         │ エラー表示 │──────────────────────────────────────┘
         │ 再試行    │            「再試行」
         └──────────┘
```

---

## ページアクセス権限マトリクス

| 画面 | 未認証 | 認証済み | 所有者 | 備考 |
|------|--------|---------|-------|------|
| ホーム `/` | ○ | ○ | - | ログイン済みはリダイレクト可 |
| ログイン `/login` | ○ | × | - | 認証済みは楽曲一覧へリダイレクト |
| 新規登録 `/register` | ○ | × | - | 認証済みは楽曲一覧へリダイレクト |
| 楽曲一覧 `/songs` | × | ○ | - | 要認証 |
| 楽曲詳細 `/songs/:id` | △ | ○ | ○ | 公開楽曲のみ未認証でも閲覧可 |
| 楽曲新規作成 `/songs/new` | × | ○ | - | 要認証 |
| エディタ `/editor/:id` | × | △ | ○ | 所有者のみ編集可 |
| 検索 `/search` | ○ | ○ | - | 公開楽曲の検索 |
| プロフィール `/profile` | × | ○ | - | 要認証 |
| 共有楽曲表示 `/share/:token` | ○ | ○ | - | 有効な共有リンクで閲覧可 |

**凡例**: ○ = アクセス可、× = アクセス不可（リダイレクト）、△ = 条件付き

---

## リダイレクトルール

| 条件 | 遷移元 | 遷移先 |
|------|--------|--------|
| 未認証で認証必須ページにアクセス | 任意 | `/login?redirect=元のURL` |
| 認証済みでログイン/登録画面にアクセス | `/login`, `/register` | `/songs` |
| 存在しない楽曲IDにアクセス | `/songs/:id`, `/editor/:id` | `/songs` + エラー表示 |
| 無効な共有トークン | `/share/:token` | `/` + エラー表示 |
| ログアウト実行 | 任意 | `/` |

---

## 関連ドキュメント

- [画面一覧](./screens.md) - 各画面の詳細仕様
- [機能一覧](../features/overview.md) - 機能詳細
- [フロントエンド設計](../architecture/frontend.md) - 技術実装
